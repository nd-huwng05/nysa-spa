<form method="POST" id="bookingForm" hx-swap-oob="true" hx-swap="none"
      hx-include="#service-ids, #inputDate, #inputTime, .staff-submit, #voucher-code"
      hx-post="/booking/create">
    <div class="summary-wrapper">
        <div class="summary-card">
            <div class="summary-top">
                <div class="small text-white-50 mb-1">SELECTED TIME</div>
                <h2 class="fw-bold m-0 booking_time" id="sumTimeDisplay">{{booking_time|default("--:--")}}</h2>
                <div class="small mt-1 text-white-50" id="sumEndTimeDisplay"></div>
                <div class="fw-medium mt-2 pt-2 border-top border-secondary" id="sumDateDisplay">
                    <i class="far fa-calendar-alt me-2"></i> {{booking_date|default("...")}}
                </div>
            </div>

            <div class="summary-content">
                <h6 class="text-uppercase text-muted fw-bold mb-3 small" style="letter-spacing: 1px;">Itinerary</h6>

                <div id="summaryTimeline">
                    <div id="time-placeholder" class="text-center text-muted py-3 small {%if total_price%}d-none{%endif%}">
                        <i class="fas fa-clock mb-2 d-block"></i>
                        Please select a time
                    </div>

                    {% for item in services %}

                    {% if item.type.value == "combo" %}
                    <div class="timeline-node js-summary-row" data-row-key="{{ item.id }}-{{ item.display_time }}" data-service-id="{{ item.id }}">
                        <div class="timeline-dot"></div>
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="time-label fw-bold js-sum-time">{{item.display_time|default("--:--")}}</span>
                                <div class="service-label fw-bold">{{ item.name }}</div>
                                <span class="staff-label">
                                    <i class="fas fa-user-check me-1"></i>
                                    <span class="js-sum-staff">
                                        {% if item.staffs %}
                                            {{ item.staffs[0].fullname }}
                                        {% else %}
                                            No staff service
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                            <div class="price-tag service-price" data-price="{{ item.price }}">
                                {{ "{:,.0f}".format(item.price) }}đ
                            </div>
                        </div>
                    </div>

                    {% for child in item.included_services %}
                    <div class="timeline-node ms-4 js-summary-child-row"
                         data-row-key="{{ child.id }}-{{ child.display_time }}"
                         data-service-id="{{ child.id }}"
                         style="border-left: 2px dashed #dee2e6;">
                        <div class="timeline-dot"
                             style="width: 8px; height: 8px; left: -4px; background: #adb5bd;"></div>
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="time-label small js-sum-time">{{child.display_time|default("--:--")}}</span>
                                <div class="service-label small text-muted">{{ child.name }}</div>
                                <span class="staff-label small">
                                    <i class="fas fa-user me-1"></i>

                                    <span class="js-sum-staff">
                                        {% if item.staffs %}
                                            {{ item.staffs[0].fullname }}
                                        {% elif child.staffs %}
                                            {{ child.staffs[0].fullname }}
                                        {% else %}
                                            No staff service
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    {% else %}
                    <div class="timeline-node js-summary-row" data-service-id="{{ item.id }}" data-row-key="{{ item.id }}-{{ item.display_time }}">
                        <div class="timeline-dot"></div>
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="time-label js-sum-time">{{item.display_time|default("--:--")}}</span>
                                <div class="service-label">{{ item.name }}</div>
                                <span class="staff-label">
                                    <i class="fas fa-user-check me-1"></i>

                                    {# --- LOGIC LẺ: Lấy người đầu tiên --- #}
                                    <span class="js-sum-staff">
                                        {% if item.staffs %}
                                            {{ item.staffs[0].fullname }}
                                        {% else %}
                                            No staff service
                                        {% endif %}
                                    </span>
                                </span>
                            </div>
                            <div class="price-tag service-price" data-price="{{ item.price }}">
                                {{ "{:,.0f}".format(item.price) }}đ
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>

            <div class="summary-content py-3 border-top border-secondary">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted small fw-medium">Subtotal:</span>
                    <span class="fw-bold text-dark" id="sumSubTotal">{{ "{:,.0f}".format(total_price | default(0)) }}đ</span>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2" id="discount-display-row">
                    <span class="text-muted small fw-medium">Voucher (<span id="appliedVoucherCode"></span>):</span>
                    <span class="fw-bold text-danger" id="discountAmount">0đ</span>
                </div>
            </div>
            <div class="total-block">
                <span class="text-muted fw-bold">FINAL TOTAL</span>
                <span class="fs-4 fw-bold text-primary" id="sumTotal">{{ "{:,.0f}".format(total_price | default(0)) }}đ</span>
            </div>
        </div>

        <button type="submit" class="btn-booking" id="btnSubmit">
            Confirm Booking <i class="fas fa-arrow-right ms-2"></i>
        </button>
    </div>
</form>