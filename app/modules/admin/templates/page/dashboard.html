{% extends "page/admin.html" %}

{% block title %}Dashboard | Nysa{% endblock %}

{% block content %}
<main class="flex-1 overflow-x-hidden overflow-y-auto bg-body p-6">

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-sm border border-gray-200 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 font-medium mb-1">Đặt thành công (Booked)</p>
                <h3 class="text-2xl font-bold text-dark">{{activities.booked}}</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-primary text-xl">
                <i class="ri-calendar-check-line"></i>
            </div>
        </div>

        <div class="bg-white p-6 rounded-sm border border-gray-200 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 font-medium mb-1">Hoàn thành (Completed)</p>
                <h3 class="text-2xl font-bold text-dark">{{activities.complete}}</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-green-50 flex items-center justify-center text-success text-xl">
                <i class="ri-flag-2-line"></i>
            </div>
        </div>

        <div class="bg-white p-6 rounded-sm border border-gray-200 shadow-sm flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500 font-medium mb-1">Bị hủy (Canceled)</p>
                <h3 class="text-2xl font-bold text-dark">{{activities.canceled}}</h3>
            </div>
            <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center text-danger text-xl">
                <i class="ri-close-circle-line"></i>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6 mb-8">

        <div class="col-span-12 lg:col-span-8 bg-white p-6 rounded-sm border border-gray-200 shadow-sm">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                <div>
                    <h4 class="text-xl font-bold text-dark">Báo cáo doanh thu</h4>
                    <p class="text-sm text-gray-500">Thu nhập theo thời gian thực</p>
                </div>
                <div class="flex bg-gray-100 p-1 rounded-md">
                    <button onclick="updateRevenue('week')" id="btn-week"
                            class="px-4 py-1 text-sm font-medium rounded shadow-sm chart-tab-active transition">Tuần
                    </button>
                    <button onclick="updateRevenue('month')" id="btn-month"
                            class="px-4 py-1 text-sm font-medium rounded transition chart-tab-inactive">Tháng
                    </button>
                    <button onclick="updateRevenue('year')" id="btn-year"
                            class="px-4 py-1 text-sm font-medium rounded transition chart-tab-inactive">Năm
                    </button>
                </div>
            </div>
            <div id="revenueChart" class="-ml-2"></div>
        </div>

        <div class="col-span-12 lg:col-span-4 bg-white p-6 rounded-sm border border-gray-200 shadow-sm">
            <h4 class="text-xl font-bold text-dark mb-4">Tỷ lệ đặt lịch</h4>
            <div class="flex justify-center">
                <div id="statusChart"></div>
            </div>
            <div class="mt-6 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="flex items-center gap-2 text-sm text-gray-600"><span
                            class="w-3 h-3 rounded-full bg-success"></span> Hoàn thành</span>
                    <span class="font-bold text-dark">{{(activities.complete/activities.total)*100}}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="flex items-center gap-2 text-sm text-gray-600"><span
                            class="w-3 h-3 rounded-full bg-primary"></span> Đã đặt</span>
                    <span class="font-bold text-dark">{{(activities.booked/activities.total)*100}}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="flex items-center gap-2 text-sm text-gray-600"><span
                            class="w-3 h-3 rounded-full bg-danger"></span> Bị hủy</span>
                    <span class="font-bold text-dark">{{(activities.canceled/activities.total)*100}}</span>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-6">

        <div class="col-span-12 lg:col-span-6 bg-white p-6 rounded-sm border border-gray-200 shadow-sm">
            <div class="mb-4">
                <h4 class="text-xl font-bold text-dark">Khung giờ vàng (Phổ biến)</h4>
                <p class="text-sm text-gray-500">Giờ nào khách hàng đặt lịch nhiều nhất?</p>
            </div>
            <div id="peakHourChart"></div>
        </div>

        <div class="col-span-12 lg:col-span-6 bg-white p-6 rounded-sm border border-gray-200 shadow-sm">
            <div class="mb-4">
                <h4 class="text-xl font-bold text-dark">Tần suất theo thứ trong tuần</h4>
                <p class="text-sm text-gray-500">Mật độ khách hàng từ Thứ 2 đến Chủ nhật</p>
            </div>
            <div id="weeklyFrequencyChart"></div>
        </div>
    </div>
</main>
{% endblock %}


{%block script %}

document.addEventListener("DOMContentLoaded", function() {
    initDashboardCharts();
});

function initDashboardCharts() {

    if (typeof ApexCharts === 'undefined' || !document.querySelector("#revenueChart")) {
        return;
    }

    const revenueData = {
        week: { data: {{statistical.week}}, categories: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'] },
        month: { data: {{statistical.month}}, categories: ['Tuần 1', 'Tuần 2', 'Tuần 3', 'Tuần 4'] },
        year: { data: {{statistical.year}}, categories: ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'] }
    };

    var revenueOptions = {
        series: [{ name: 'Doanh thu (VNĐ)', data: revenueData.week.data }],
        chart: { height: 350, type: 'area', toolbar: {show: false}, fontFamily: 'Inter, sans-serif' },
        colors: ['#3C50E0'],
        dataLabels: {enabled: false},
        stroke: {curve: 'smooth', width: 2},
        xaxis: { categories: revenueData.week.categories, axisBorder: {show: false}, axisTicks: {show: false} },
        grid: { strokeDashArray: 4, yaxis: {lines: {show: true}} },
        fill: { type: 'gradient', gradient: {shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.05, stops: [0, 90, 100]} },
    };

    window.revenueChartInstance = new ApexCharts(document.querySelector("#revenueChart"), revenueOptions);
    window.revenueChartInstance.render();


    window.updateRevenue = function (type) {
        if (!window.revenueChartInstance) return;

        window.revenueChartInstance.updateOptions({ xaxis: {categories: revenueData[type].categories} });
        window.revenueChartInstance.updateSeries([{ data: revenueData[type].data }]);

        const buttons = ['btn-week', 'btn-month', 'btn-year'];
        buttons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                if (btnId === 'btn-' + type) {
                    btn.classList.add('chart-tab-active');
                    btn.classList.remove('chart-tab-inactive');
                } else {
                    btn.classList.remove('chart-tab-active');
                    btn.classList.add('chart-tab-inactive');
                }
            }
        });
    };

    var statusOptions = {
        series: [{{activities.complete}}, {{activities.booked}}, {{activities.canceled}}],
        labels: ['Hoàn thành', 'Đang đặt', 'Bị hủy'],
        chart: {type: 'donut', height: 320, fontFamily: 'Inter, sans-serif'},
        colors: ['#10B981', '#3C50E0', '#FB5454'],
        plotOptions: {
            pie: { donut: { size: '70%', labels: { show: true, total: { show: true, label: 'Tổng lịch', fontSize: '16px', fontWeight: 600, color: '#64748B', formatter: function (w) { return w.globals.seriesTotals.reduce((a, b) => { return a + b }, 0) } } } } }
        },
        legend: {show: false},
        dataLabels: {enabled: false}
    };
    new ApexCharts(document.querySelector("#statusChart"), statusOptions).render();

    var peakHourOptions = {
        series: [{name: 'Số lượt đặt', data: {{time_gold}}}],
        chart: {type: 'bar', height: 300, toolbar: {show: false}, fontFamily: 'Inter, sans-serif'},
        plotOptions: {bar: {borderRadius: 4, horizontal: false, columnWidth: '50%'}},
        colors: ['#80CAEE'],
        dataLabels: {enabled: false},
        xaxis: { categories: ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00'], title: {text: 'Giờ'} }
    };
    new ApexCharts(document.querySelector("#peakHourChart"), peakHourOptions).render();

    var frequencyOptions = {
        series: [{name: 'Lượt khách', data: {{frequency}}}],
        chart: {height: 300, type: 'area', toolbar: {show: false}, fontFamily: 'Inter, sans-serif'},
        colors: ['#F59E0B'],
        stroke: {curve: 'smooth', width: 3},
        xaxis: {categories: ['CN','T2', 'T3', 'T4', 'T5', 'T6', 'T7']},
        fill: { type: 'gradient', gradient: {shadeIntensity: 1, opacityFrom: 0.6, opacityTo: 0.1, stops: [0, 90, 100]} }
    };
    new ApexCharts(document.querySelector("#weeklyFrequencyChart"), frequencyOptions).render();
}
{%endblock %}
